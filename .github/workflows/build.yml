name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # 允许手动触发

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SQLX_OFFLINE: true  # 禁用 SQLx 编译时查询验证
  RUSTFLAGS: -A dead_code -A unused_comparisons  # 允许 dead code 和无用的比较警告
  CARGO_NET_RETRY: 10
  CARGO_INCREMENTAL: 0

jobs:
  build-server:
    name: Build Server
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install protoc
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: server/target
        key: ${{ runner.os }}-cargo-build-server-${{ hashFiles('**/Cargo.lock') }}

    - name: Build server
      working-directory: ./server
      run: cargo build --verbose --release

    - name: Run server tests
      working-directory: ./server
      run: cargo test --verbose

    - name: Upload server binary
      uses: actions/upload-artifact@v4
      with:
        name: claude-sync-server-linux
        path: server/target/release/claude-sync-server
        if-no-files-found: error

  build-client:
    name: Build Client
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: claude-sync-client-linux
          - os: windows-latest
            artifact_name: claude-sync-client-windows.exe
          - os: macos-latest
            artifact_name: claude-sync-client-macos

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install protoc (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Install protoc (macOS)
      if: runner.os == 'macOS'
      run: brew install protobuf

    - name: Install protoc (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install protoc -y
        echo "$env:ProgramFiles\protobuf" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: client/target
        key: ${{ runner.os }}-cargo-build-client-${{ hashFiles('**/Cargo.lock') }}

    - name: Build client
      working-directory: ./client
      run: cargo build --verbose --release

    - name: Run client tests
      working-directory: ./client
      run: cargo test --verbose

    - name: Upload client binary
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: client/target/release/claude-sync*
        if-no-files-found: error

  # 生成 protobuf 代码并作为 artifact 下载
  generate-proto:
    name: Generate Protobuf Code
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install protoc
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Generate server proto code
      working-directory: ./server
      run: cargo build

    - name: Generate client proto code
      working-directory: ./client
      run: cargo build

    - name: Upload generated proto files (server)
      uses: actions/upload-artifact@v4
      with:
        name: server-proto-code
        path: server/src/proto/**/*.rs

    - name: Upload generated proto files (client)
      uses: actions/upload-artifact@v4
      with:
        name: client-proto-code
        path: client/src/proto/**/*.rs

  # 格式化检查
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install protoc
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rustfmt

    - name: Check formatting
      run: |
        cd server && cargo fmt -- --check
        cd ../client && cargo fmt -- --check

  # Clippy 检查
  clippy-check:
    name: Clippy Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install protoc
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: clippy

    - name: Run clippy
      run: |
        cd server && cargo clippy -- -D warnings -A dead_code -A unused_comparisons
        cd ../client && cargo clippy -- -D warnings -A dead_code -A unused_comparisons

  # 构建 GUI 客户端
  build-gui-client:
    name: Build GUI Client
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: claude-sync-gui-linux
            build_args: ''
          - os: windows-latest
            artifact_name: claude-sync-gui-windows
            build_args: ''
          - os: macos-latest
            artifact_name: claude-sync-gui-macos
            build_args: '--target universal-apple-darwin'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install protoc (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler libwebkit2gtk-4.1-dev \
          build-essential curl wget file libssl-dev libayatana-appindicator3-dev \
          librsvg2-dev

    - name: Install protoc (macOS)
      if: runner.os == 'macOS'
      run: brew install protobuf

    - name: Install protoc (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install protoc -y
        echo "$env:ProgramFiles\protobuf" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-gui-${{ hashFiles('gui-client/**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-gui-${{ hashFiles('gui-client/**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: gui-client/src-tauri/target
        key: ${{ runner.os }}-cargo-build-gui-${{ hashFiles('gui-client/**/Cargo.lock') }}

    - name: Install GUI client dependencies
      working-directory: ./gui-client
      run: npm install

    - name: Build GUI client
      working-directory: ./gui-client
      run: npm run build ${{ matrix.build_args }}
      env:
        TAURI_BUNDLE_LICENSE: MIT

    - name: Upload GUI client bundle (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          gui-client/src-tauri/target/release/bundle/deb/*.deb
          gui-client/src-tauri/target/release/bundle/appimage/*.AppImage
        if-no-files-found: warn

    - name: Upload GUI client bundle (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          gui-client/src-tauri/target/release/bundle/msi/*.msi
          gui-client/src-tauri/target/release/bundle/nsis/*.exe
        if-no-files-found: warn

    - name: Upload GUI client bundle (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          gui-client/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
          gui-client/src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app
        if-no-files-found: warn
